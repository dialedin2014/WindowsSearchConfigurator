# Implementation Plan: COM API Registration Support

**Branch**: `002-com-api-registration` | **Date**: 2025-10-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-com-api-registration/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

The COM API Registration Support feature enables WindowsSearchConfigurator to detect when the Microsoft.Search.Interop.CSearchManager COM API is not registered on the system and offer to register it automatically. The feature provides clear notifications when the API is missing, offers interactive and non-interactive registration modes, checks for administrative privileges before attempting registration, and provides fallback guidance for manual registration if automatic registration fails. This ensures the tool can function on systems where the COM API is not properly registered while maintaining user control and providing clear feedback throughout the registration process.

## Technical Context

**Language/Version**: C# / .NET 8.0 (LTS) - targeting Windows 10/11 and Windows Server 2016+  
**Primary Dependencies**: 
- System.Runtime.InteropServices (COM interop and DLL registration)
- System.Security.Principal (privilege checking)
- System.Diagnostics (process execution for regsvr32)
- Existing WindowsSearchConfigurator infrastructure (logging, console formatting)

**Storage**: 
- Windows Registry (reading COM registration state: HKEY_CLASSES_ROOT\CLSID)
- Application logs (registration attempts and outcomes)

**Testing**: 
- NUnit (unit testing framework - existing project standard)
- Moq (mocking COM registration APIs and privilege checks)
- FluentAssertions (assertion library - existing project standard)
- Integration tests requiring administrative privileges and Windows Search components

**Target Platform**: Windows 10 (1809+), Windows 11, Windows Server 2016+  
**Project Type**: Single console application (enhancement to existing CLI)  
**Performance Goals**: 
- COM registration detection: <500ms (before any command execution)
- Registration attempt (with admin privileges): <5 seconds
- User decision prompt: <1 minute total interaction time

**Constraints**: 
- Must integrate seamlessly with existing WindowsSearchConfigurator architecture
- Cannot require additional external dependencies
- Must work in both interactive and non-interactive (scripted/CI) modes
- Must handle missing DLL files gracefully (not just unregistered)
- Must not break existing functionality when COM API is already registered

**Scale/Scope**: 
- 2-3 new service classes (COM detection, registration, privilege checking enhancement)
- 1 startup integration point (Program.cs)
- 2 command-line flags (--auto-register-com, --no-register-com)
- Integration with existing logging and console output infrastructure

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Automated Testing ✅ PASS
- **Requirement**: All production code MUST have automated tests (unit, integration, contract)
- **Compliance**: 
  - Unit tests planned for COM detection logic, privilege checking, and registration orchestration
  - Integration tests for actual COM registration attempts (requires admin privileges)
  - Contract tests for new command-line flags and error message formats
  - Test-first approach for critical paths (detection logic, privilege escalation guidance)
- **Testing Requirements for This Feature**:
  - Unit tests: COMRegistrationDetector, COMRegistrationService, enhanced PrivilegeChecker
  - Integration tests: Full registration flow on systems with/without COM API registered
  - Contract tests: Command-line flag behavior (--auto-register-com, --no-register-com)
  - Edge case tests: Missing DLL, partial registration, interrupted registration
- **Status**: COMPLIANT - Comprehensive testing strategy defined

### II. Windows API Safety ✅ PASS
- **Requirement**: All Windows Search API calls MUST include proper error handling and validation
- **Compliance**:
  - All COM detection calls wrapped in try-catch with specific error handling
  - Registry access for CLSID detection includes error handling for missing keys
  - Process execution (regsvr32) includes timeout, exit code checking, and error message capture
  - Clear fallback paths when automatic registration fails (manual instructions)
  - Validation of COM API functionality after registration before proceeding
- **Status**: COMPLIANT - Error handling and validation strategy defined

### III. User Configuration Control ✅ PASS
- **Requirement**: Users MUST maintain full control over configuration changes
- **Compliance**:
  - Interactive mode requires explicit user confirmation before registration
  - Clear explanation of what registration will do and why it's needed
  - Non-interactive modes require explicit flags (--auto-register-com or --no-register-com)
  - Users can decline registration and receive manual instructions
  - No silent or automatic registration without user knowledge
- **Status**: COMPLIANT - User control mechanisms defined

### IV. Clear Interface Design ✅ PASS
- **Requirement**: All interfaces MUST be clear and discoverable
- **Compliance**:
  - Clear, non-technical error messages explaining COM API missing (FR-002, SC-004)
  - Self-explanatory command-line flags (--auto-register-com, --no-register-com)
  - Helpful guidance when registration fails (manual steps, troubleshooting)
  - Progress feedback during registration process
  - Consistent with existing WindowsSearchConfigurator CLI patterns
- **Status**: COMPLIANT - Interface design principles defined

### V. Documentation and Maintainability ✅ PASS
- **Requirement**: Code MUST be documented and maintainable
- **Compliance**:
  - quickstart.md will be updated with COM API registration troubleshooting section
  - Public APIs for COM detection and registration include XML documentation
  - Complex registry/COM interop code documented with rationale
  - Manual registration instructions documented for fallback scenarios
- **Status**: COMPLIANT - Documentation approach defined

### VI. Incremental Implementation ✅ PASS
- **Requirement**: Implementation tasks limited to 4-6 files per batch
- **Compliance**:
  - Feature decomposed into 4 user stories (P1-P3)
  - Batch 1: COM detection + notification (2-3 files)
  - Batch 2: Interactive registration + privilege checking (2-3 files)
  - Batch 3: Non-interactive mode flags (1-2 files)
  - Batch 4: Integration tests + documentation (2-3 files)
- **Status**: COMPLIANT - Incremental implementation strategy defined

### VII. Source Control Discipline ✅ PASS
- **Requirement**: All development follows GitHub-based source control practices
- **Compliance**:
  - Feature branch `002-com-api-registration` already created
  - Conventional commits will be used (feat(com): ..., fix(com): ..., test(com): ...)
  - Frequent commits after each logical unit (detection, registration, flags, tests)
  - GitHub CLI will be used for PR creation and management
- **Status**: COMPLIANT - Source control workflow defined

**Overall Gate Status**: ✅ ALL GATES PASS

**Post-Design Re-evaluation**: ✅ CONFIRMED - All principles maintained after Phase 0 Research and Phase 1 Design
- research.md: All 9 technical decisions comply with constitution principles, use standard .NET APIs
- data-model.md: Domain model includes comprehensive validation rules, clear state transitions, error handling
- contracts/cli-contract.md: CLI design follows clear interface principles with detailed help text, exit codes, and behavior matrix
- quickstart.md: Developer documentation provides comprehensive guidance on implementation, testing, and troubleshooting
- All design artifacts emphasize automated testing, Windows API safety, and user control

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
WindowsSearchConfigurator/
├── src/
│   └── WindowsSearchConfigurator/
│       ├── Program.cs                          # MODIFIED: Add COM detection on startup
│       ├── Services/
│       │   ├── COMRegistrationDetector.cs      # NEW: Detect COM API registration status
│       │   ├── COMRegistrationService.cs       # NEW: Handle COM API registration
│       │   └── PrivilegeChecker.cs             # MODIFIED: Enhanced for COM registration context
│       ├── Infrastructure/
│       │   └── WindowsSearchInterop.cs         # MODIFIED: Add COM validation after registration
│       └── Utilities/
│           └── ConsoleFormatter.cs             # MODIFIED: Add COM registration prompts/messages
├── tests/
│   ├── WindowsSearchConfigurator.UnitTests/
│   │   ├── Services/
│   │   │   ├── COMRegistrationDetectorTests.cs     # NEW: Unit tests for detection
│   │   │   ├── COMRegistrationServiceTests.cs      # NEW: Unit tests for registration
│   │   │   └── PrivilegeCheckerTests.cs            # MODIFIED: Add COM-specific tests
│   │   └── Infrastructure/
│   │       └── WindowsSearchInteropTests.cs        # MODIFIED: Add COM validation tests
│   ├── WindowsSearchConfigurator.IntegrationTests/
│   │   └── COMRegistrationIntegrationTests.cs      # NEW: End-to-end registration tests
│   └── WindowsSearchConfigurator.ContractTests/
│       └── COMRegistrationContractTests.cs          # NEW: CLI flag behavior tests
└── specs/
    └── 002-com-api-registration/
        ├── plan.md                  # This file
        ├── research.md              # Phase 0 output (pending)
        ├── data-model.md            # Phase 1 output (pending)
        ├── quickstart.md            # Phase 1 output (pending)
        └── contracts/               # Phase 1 output (pending)
```

**Structure Decision**: This feature enhances the existing single console application (WindowsSearchConfigurator) rather than creating a new project. The implementation adds 2 new service classes for COM detection and registration, modifies existing startup and interop code, and adds comprehensive test coverage across all three test projects (unit, integration, contract). This approach maintains the existing project structure while adding focused, testable components that integrate cleanly with the existing architecture.

## Implementation Phases

### Phase 0: Research ✅ COMPLETE

**Output**: [research.md](./research.md)

**Key Decisions**:
1. Use Registry-based COM detection (CLSID lookup)
2. Execute regsvr32.exe via Process for registration
3. WindowsPrincipal.IsInRole for privilege detection
4. Command-line flags for non-interactive modes
5. Tiered error messaging with manual fallback
6. COM object instantiation for validation
7. Program.cs startup integration
8. Three-tier testing strategy (unit, integration, contract)
9. Extend existing AuditLogger for COM events

### Phase 1: Design ✅ COMPLETE

**Outputs**: 
- [data-model.md](./data-model.md) - Domain entities, service interfaces, data flow
- [contracts/cli-contract.md](./contracts/cli-contract.md) - CLI flags, exit codes, console output
- [quickstart.md](./quickstart.md) - Developer implementation guide
- [.github/copilot-instructions.md](../../.github/copilot-instructions.md) - Updated with C# / .NET 8.0

**Key Artifacts**:
- Domain model: COMRegistrationStatus, COMRegistrationAttempt, enums (ValidationState, RegistrationMode, RegistrationOutcome, RegistrationOptions)
- Service interfaces: ICOMRegistrationDetector, ICOMRegistrationService
- CLI contract: --auto-register-com, --no-register-com, exit codes, behavior matrix
- Data flows: Startup detection, registration, validation

### Phase 2: Tasks (NEXT - Use /speckit.tasks)

**Output**: tasks.md (to be generated)

**Expected Task Batches**:
1. **Batch 1**: COM Detection (4 files)
   - COMRegistrationDetector.cs (new)
   - COMRegistrationDetectorTests.cs (new)
   - WindowsSearchInterop.cs (modify - add validation)
   - WindowsSearchInteropTests.cs (modify)

2. **Batch 2**: Interactive Registration (5 files)
   - COMRegistrationService.cs (new)
   - COMRegistrationServiceTests.cs (new)
   - PrivilegeChecker.cs (modify)
   - PrivilegeCheckerTests.cs (modify)
   - ConsoleFormatter.cs (modify - add prompts)

3. **Batch 3**: Non-Interactive Flags (3 files)
   - Program.cs (modify - add global options)
   - COMRegistrationService.cs (modify - handle flags)
   - COMRegistrationContractTests.cs (new)

4. **Batch 4**: Integration & Documentation (4 files)
   - COMRegistrationIntegrationTests.cs (new)
   - README.md (modify - add COM troubleshooting)
   - CHANGELOG.md (modify - document feature)
   - Final integration testing

**Testing Tasks** (included in batches above):
- Unit tests: COMRegistrationDetectorTests, COMRegistrationServiceTests, PrivilegeCheckerTests
- Integration tests: COMRegistrationIntegrationTests (requires admin)
- Contract tests: COMRegistrationContractTests (CLI flags, exit codes)
- Manual testing: Interactive prompts, privilege scenarios, edge cases

## Next Steps

1. **Review Planning Artifacts**:
   - ✅ spec.md (user requirements)
   - ✅ research.md (technical decisions)
   - ✅ data-model.md (domain model)
   - ✅ contracts/cli-contract.md (CLI behavior)
   - ✅ quickstart.md (implementation guide)

2. **Generate Task List**:
   ```
   Run: /speckit.tasks
   ```
   This will create tasks.md with detailed implementation tasks organized into 4-6 file batches.

3. **Begin Implementation**:
   ```
   Run: /speckit.implement
   ```
   This will execute tasks from tasks.md in order, respecting the 4-6 file batch limit.

4. **Continuous Integration**:
   - Commit frequently with conventional commits (feat(com): ...)
   - Run tests after each batch
   - Update documentation as you go

5. **Final Steps**:
   - Run full test suite
   - Test on clean VM (both admin and standard user scenarios)
   - Update README.md with COM troubleshooting
   - Create PR: `gh pr create --title "feat(com): Add COM API registration support"`

## Success Criteria

This feature will be complete when:

- ✅ All functional requirements (FR-001 through FR-012) are implemented
- ✅ All success criteria (SC-001 through SC-006) are met
- ✅ All automated tests pass (unit, integration, contract)
- ✅ Constitution gates remain green (automated testing, Windows API safety, user control)
- ✅ Documentation is updated (README, CHANGELOG, quickstart)
- ✅ Manual testing confirms all user stories work as expected
- ✅ Code review completed with approval
- ✅ GitHub Actions CI pipeline passes
