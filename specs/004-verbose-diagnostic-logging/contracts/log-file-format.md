# Log File Format Contract

**Feature**: 004-verbose-diagnostic-logging  
**Version**: 1.0  
**Date**: October 23, 2025

## Overview

This contract defines the format and structure of diagnostic log files generated by the Windows Search Configurator tool when running in verbose mode. This contract ensures consistent log file formatting that can be reliably parsed and validated by automated tests.

## File Naming Convention

### Pattern
```
WindowsSearchConfigurator_{timestamp}_{guid}.log
```

### Components
- **Prefix**: Always `WindowsSearchConfigurator_` (case-sensitive)
- **Timestamp**: `yyyyMMdd_HHmmss` format (e.g., `20251023_143055`)
  - Year: 4 digits
  - Month: 2 digits (01-12)
  - Day: 2 digits (01-31)
  - Hour: 2 digits (00-23, 24-hour format)
  - Minute: 2 digits (00-59)
  - Second: 2 digits (00-59)
  - Separator: underscore between date and time components
- **GUID**: First 6 characters of a GUID (lowercase hexadecimal)
- **Extension**: `.log`

### Examples
- Valid: `WindowsSearchConfigurator_20251023_143055_a3f8d2.log`
- Valid: `WindowsSearchConfigurator_20251225_000000_1a2b3c.log`
- Invalid: `windowssearchconfigurator_20251023_143055_a3f8d2.log` (wrong case)
- Invalid: `WindowsSearchConfigurator_2025-10-23_14:30:55_a3f8d2.log` (wrong separators)
- Invalid: `WindowsSearchConfigurator_20251023_143055.log` (missing GUID)

### Regex Pattern
```regex
^WindowsSearchConfigurator_\d{8}_\d{6}_[a-f0-9]{6}\.log$
```

## Log File Structure

### Overall Format

Every log file MUST contain:
1. Session Header (exactly once, at start)
2. Zero or more Log Entries
3. Session Footer (exactly once, at end)

### Session Header

**Format**:
```
================================ LOG SESSION START ================================
Session ID: {GUID}
Start Time: {ISO8601-UTC-Timestamp}
Command: {CommandLine}
User: {WindowsUsername}
Working Directory: {DirectoryPath}
Windows Version: {VersionString}
.NET Runtime: {RuntimeVersion}
===================================================================================
```

**Rules**:
- MUST be the first content in the log file
- Header line: exactly 83 equals signs, surrounded by spaces and text
- Each metadata line: `{Key}: {Value}` format
- Keys are fixed and case-sensitive
- Session ID: standard GUID format with hyphens (e.g., `a3f8d2c4-1234-5678-9abc-def012345678`)
- Start Time: ISO 8601 format with milliseconds and Z suffix (e.g., `2025-10-23T14:30:55.123Z`)
- Command: full command line including executable name
- User: Windows domain\username or just username format
- Working Directory: absolute path
- Windows Version: human-readable format (e.g., "Windows 11 22H2 Build 22621")
- .NET Runtime: version string (e.g., "8.0.0")
- Footer line: exactly 83 equals signs

**Example**:
```
================================ LOG SESSION START ================================
Session ID: a3f8d2c4-1234-5678-9abc-def012345678
Start Time: 2025-10-23T14:30:55.123Z
Command: WindowsSearchConfigurator.exe add C:\Data --verbose
User: DOMAIN\jsmith
Working Directory: C:\Users\jsmith\Desktop
Windows Version: Windows 11 22H2 (Build 22621.2134)
.NET Runtime: 8.0.0
===================================================================================
```

### Log Entry

**Format**:
```
[{Timestamp}] [{Severity}] {Component}: {Message}
{OptionalStackTrace}
```

**Rules**:
- Timestamp: ISO 8601 format with milliseconds and Z suffix in square brackets
  - Format: `[yyyy-MM-ddTHH:mm:ss.fffZ]`
  - Example: `[2025-10-23T14:30:55.123Z]`
- Severity: One of `INFO`, `OPERATION`, `WARNING`, `ERROR`, `EXCEPTION` in square brackets
  - Always uppercase
  - Example: `[INFO]`
- Component: Name of the component/service generating the log entry
  - Must not contain colons
  - Examples: `Startup`, `RegistryAccessor`, `SearchIndexManager`
- Message: Human-readable log message
  - May span multiple lines for exceptions
  - Must not be empty
- Stack Trace: (optional, only for EXCEPTION severity)
  - Follows message on subsequent lines
  - Standard .NET stack trace format
  - Indented or left-aligned based on .NET Exception.StackTrace output

**Examples**:

Simple info entry:
```
[2025-10-23T14:30:55.123Z] [INFO] Startup: Windows Search Configurator starting...
```

Operation entry:
```
[2025-10-23T14:30:55.145Z] [OPERATION] RegistryAccessor: Reading key HKLM\SOFTWARE\Microsoft\Windows Search\CrawlScopeManager
```

Error entry:
```
[2025-10-23T14:30:55.890Z] [ERROR] SearchIndexManager: Failed to add path: Access denied
```

Exception entry with stack trace:
```
[2025-10-23T14:30:55.891Z] [EXCEPTION] System.UnauthorizedAccessException: Access denied
Stack Trace:
   at WindowsSearchConfigurator.Services.SearchIndexManager.AddPath(String path)
   at WindowsSearchConfigurator.Commands.AddCommand.ExecuteAsync(...)
```

### Session Footer

**Format**:
```
================================= LOG SESSION END =================================
End Time: {ISO8601-UTC-Timestamp}
Duration: {Seconds} seconds
Exit Code: {ExitCode}
Status: {Status}
===================================================================================
```

**Rules**:
- MUST be the last content in the log file
- Header line: exactly 83 equals signs, surrounded by spaces and text
- Each metadata line: `{Key}: {Value}` format
- Keys are fixed and case-sensitive
- End Time: ISO 8601 format with milliseconds and Z suffix
- Duration: Decimal number with up to 3 decimal places, followed by " seconds"
  - Format: `{number} seconds` (e.g., `10.234 seconds`)
- Exit Code: Integer (typically 0 for success, non-zero for failure)
- Status: One of `SUCCESS`, `FAILED`, `ABORTED` (uppercase)
- Footer line: exactly 83 equals signs

**Example**:
```
================================= LOG SESSION END =================================
End Time: 2025-10-23T14:31:05.234Z
Duration: 10.111 seconds
Exit Code: 0
Status: SUCCESS
===================================================================================
```

## Encoding

- **Character Encoding**: UTF-8
- **Byte Order Mark**: No BOM
- **Line Endings**: Windows (CRLF) or Unix (LF) - both acceptable

## Validation Rules

### File Level
1. File name MUST match naming pattern
2. File MUST be valid UTF-8 text
3. File MUST contain exactly one session header
4. File MUST contain exactly one session footer
5. Session header MUST be first content
6. Session footer MUST be last content
7. Log entries MUST appear between header and footer

### Session Header
1. MUST contain all required metadata fields in order
2. Session ID MUST be valid GUID format
3. Start Time MUST be valid ISO 8601 timestamp with milliseconds
4. All fields MUST have non-empty values

### Log Entry
1. Timestamp MUST be valid ISO 8601 format with milliseconds
2. Timestamp MUST be >= session start time
3. Timestamp MUST be <= session end time (if footer present)
4. Severity MUST be one of the defined values
5. Component MUST be non-empty
6. Message MUST be non-empty
7. Stack trace MAY be present only for EXCEPTION severity

### Session Footer
1. MUST contain all required metadata fields in order
2. End Time MUST be valid ISO 8601 timestamp
3. End Time MUST be >= Start Time
4. Duration MUST be positive number
5. Exit Code MUST be integer
6. Status MUST be one of the defined values

## Contract Tests

Contract tests MUST verify:
1. ✅ Generated log file names match naming pattern
2. ✅ Log files are valid UTF-8
3. ✅ Session header is present and correctly formatted
4. ✅ Session footer is present and correctly formatted
5. ✅ All log entries follow the format pattern
6. ✅ Timestamps are monotonically increasing or equal
7. ✅ Severity values are valid
8. ✅ Duration calculation matches (EndTime - StartTime)
9. ✅ No content appears before header or after footer
10. ✅ Files can be parsed by standard text processing tools

## Sample Valid Log File

```
================================ LOG SESSION START ================================
Session ID: a3f8d2c4-1234-5678-9abc-def012345678
Start Time: 2025-10-23T14:30:55.000Z
Command: WindowsSearchConfigurator.exe add C:\Data --verbose
User: DOMAIN\jsmith
Working Directory: C:\Users\jsmith\Desktop
Windows Version: Windows 11 22H2 (Build 22621.2134)
.NET Runtime: 8.0.0
===================================================================================
[2025-10-23T14:30:55.123Z] [INFO] Startup: Windows Search Configurator starting...
[2025-10-23T14:30:55.125Z] [INFO] Startup: Command-line arguments: add C:\Data --verbose
[2025-10-23T14:30:55.130Z] [OPERATION] RegistryAccessor: Reading key HKLM\SOFTWARE\Microsoft\Windows Search
[2025-10-23T14:30:55.145Z] [INFO] ServiceStatusChecker: Checking Windows Search service status
[2025-10-23T14:30:55.200Z] [OPERATION] SearchIndexManager: Adding path C:\Data to index
[2025-10-23T14:30:55.890Z] [ERROR] SearchIndexManager: Failed to add path
[2025-10-23T14:30:55.891Z] [EXCEPTION] System.UnauthorizedAccessException: Access denied
Stack Trace:
   at WindowsSearchConfigurator.Services.SearchIndexManager.AddPath(String path)
================================= LOG SESSION END =================================
End Time: 2025-10-23T14:31:05.234Z
Duration: 10.234 seconds
Exit Code: 1
Status: FAILED
===================================================================================
```

## Backwards Compatibility

- **Version 1.0**: Initial format
- Future versions MAY add optional fields to session metadata
- Future versions MUST NOT remove or reorder existing required fields
- Future versions MAY add new severity levels
- Log parsers SHOULD ignore unknown metadata fields
- Log parsers SHOULD handle unknown severity levels gracefully

## Security Considerations

Log files MAY contain sensitive information:
- Registry key paths and values
- File system paths
- User names
- Windows version information

**Recommendations**:
- Warn users that log files may contain system configuration details
- Document that logs should be reviewed before sharing publicly
- Do NOT log credentials, passwords, or authentication tokens
- Do NOT log personally identifiable information (PII) beyond username

---

**Contract Version**: 1.0  
**Status**: Final  
**Last Updated**: October 23, 2025
